import os
import requests
from bs4 import BeautifulSoup

DISCORD_WEBHOOK = os.getenv("DISCORD_WEBHOOK")
SEARCH_TERMS = ["iphone", "samsung galaxy", "xiaomi"]
MAX_RESULTS = 3

def send_discord(title, price, url, source):
    if not DISCORD_WEBHOOK:
        print("Brak DISCORD_WEBHOOK")
        return
    payload = {
        "username": "AukcjeBot",
        "embeds": [{
            "title": title,
            "url": url,
            "description": f"ðŸ’¸ Cena: {price}\nðŸ“Œ Å¹rÃ³dÅ‚o: {source}"
        }]
    }
    try:
        requests.post(DISCORD_WEBHOOK, json=payload)
    except:
        pass

def scrape_allegro(term):
    url = f"https://allegro.pl/listing?string={term}"
    r = requests.get(url, headers={"User-Agent":"Mozilla/5.0"})
    soup = BeautifulSoup(r.text, "html.parser")
    items = soup.select("a[href]")[:MAX_RESULTS]
    for a in items:
        href = a.get("href")
        title = a.get_text(strip=True)
        if href and title:
            send_discord(title, "Brak ceny", href, "Allegro")

def scrape_olx(term):
    url = f"https://www.olx.pl/oferty/q-{term}/"
    r = requests.get(url, headers={"User-Agent":"Mozilla/5.0"})
    soup = BeautifulSoup(r.text, "html.parser")
    items = soup.select("a.css-rc5s2u")[:MAX_RESULTS]
    for a in items:
        href = a.get("href")
        title = a.get_text(strip=True)
        if href and title:
            send_discord(title, "Brak ceny", href, "OLX")

def scrape_vinted(term):
    url = f"https://www.vinted.pl/catalog?search_text={term}"
    r = requests.get(url, headers={"User-Agent":"Mozilla/5.0"})
    soup = BeautifulSoup(r.text, "html.parser")
    items = soup.select("a.catalog-item__link")[:MAX_RESULTS]
    for a in items:
        href = "https://www.vinted.pl" + a.get("href")
        title = a.get_text(strip=True)
        if href and title:
            send_discord(title, "Brak ceny", href, "Vinted")

for term in SEARCH_TERMS:
    scrape_allegro(term)
    scrape_olx(term)
    scrape_vinted(term)
